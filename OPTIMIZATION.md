# Оптимизация производительности приложения

В этом документе описаны изменения, внесенные для оптимизации производительности приложения, особенно в части работы с базой данных NEON.

## Внесенные изменения

### 1. Оптимизация API-эндпоинтов

- **Устранение проблемы N+1 запросов**: Объединены множественные запросы в один с использованием `include` и `Promise.all`.
- **Добавление пагинации**: Добавлена пагинация для всех эндпоинтов, возвращающих списки данных.
- **Оптимизация запросов**: Улучшены запросы для выборки только необходимых данных.
- **Использование транзакций**: Добавлены транзакции для атомарных операций.

### 2. Оптимизация подключения к базе данных

- **Единый экземпляр PrismaClient**: Обеспечено использование одного экземпляра PrismaClient во всех API-эндпоинтах.
- **Оптимизация пула соединений**: Настроен пул соединений для эффективного использования ресурсов.

### 3. Решение проблемы холодного старта NEON

- **Механизм keep-alive**: Добавлен механизм для периодического "пробуждения" базы данных.
- **Предварительная загрузка данных**: Реализована предварительная загрузка часто используемых данных.

### 4. Оптимизация клиентской стороны

- **Улучшение использования React Query**: Оптимизированы настройки кэширования и повторных запросов.
- **Предварительная загрузка данных**: Добавлена предварительная загрузка данных для часто используемых страниц.

### 5. Добавление индексов в базу данных

Созданы индексы для оптимизации запросов:

- Индексы для TelegramUser: `tgId`
- Индексы для Block: `order`
- Индексы для Question: `blockId`, `practiceId`, `order`, `(blockId, order)`
- Индексы для Answer: `userId`, `questionId`, `(userId, questionId)`, `createdAt`

## Инструкции по применению индексов

Поскольку база данных находится на NEON и управляется через Vercel, необходимо выполнить SQL-скрипт для добавления индексов:

1. Войдите в панель управления NEON.
2. Откройте SQL-редактор.
3. Выполните скрипт из файла `prisma/add_indexes.sql`.

## Дополнительные рекомендации

### Мониторинг производительности

- Используйте инструменты мониторинга NEON для отслеживания производительности запросов.
- Логируйте медленные запросы для дальнейшей оптимизации.

### Дальнейшая оптимизация

- Рассмотрите возможность использования кэширования на уровне приложения (например, Redis).
- Оптимизируйте размер передаваемых данных, особенно для мобильных устройств.
- Рассмотрите возможность использования GraphQL для более гибкой выборки данных.

## Результаты оптимизации

После внесения этих изменений ожидается значительное улучшение производительности приложения:

- Уменьшение времени загрузки данных из базы данных.
- Снижение нагрузки на сервер базы данных.
- Улучшение пользовательского опыта за счет более быстрой загрузки страниц.
- Предотвращение проблем с холодным стартом NEON. 